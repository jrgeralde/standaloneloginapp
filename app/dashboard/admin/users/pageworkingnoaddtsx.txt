'use client';

import { useCallback, useEffect, useMemo, useState } from 'react';
import { useRouter } from 'next/navigation';
import MessageModal from '@/components/MessageModal';
import ConfirmModal from '@/components/ConfirmModal';

// --- Types ---
type User = {
  id: number;
  name: string;
  active: boolean;
  fullname: string | null;
  birthdate: Date | null;
  gender: string | null;
};

type RawUser = {
  id: number;
  name: string;
  active: boolean;
  fullname: string | null;
  birthdate: string | null; 
  gender: string | null;
};

// --- Helpers ---
const normalizeUser = (user: RawUser): User => ({
  id: typeof user?.id === 'string' ? Number(user.id) : user?.id ?? 0,
  name: user?.name ?? '',
  active: !!user?.active,
  fullname: user?.fullname ?? null,
  birthdate: user?.birthdate ? new Date(user.birthdate) : null,
  gender: user?.gender ?? null,
});

export default function UsersPage() {
  const router = useRouter();
  
  const [users, setUsers] = useState<User[]>([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState('');
  const [message, setMessage] = useState('');
  const [searchTerm, setSearchTerm] = useState('');

  const username = typeof window !== 'undefined' ? sessionStorage.getItem('username') : null;

  // --- API CALL: Toggle Status ---
  const handleToggleStatus = async (user: User) => {
    const action = user.active ? 'deactivate' : 'activate';
    
    // Use your Promise-based ConfirmModal
    const confirmed = await ConfirmModal(
      `Are you sure you want to ${action} user "${user.name}"?`,
      {
        okText: user.active ? 'Deactivate' : 'Activate',
        cancelText: 'Cancel',
        okColor: user.active ? 'bg-red-600 hover:bg-red-700' : 'bg-green-600 hover:bg-green-700',
      }
    );

    if (!confirmed) return;

    try {
      const res = await fetch(`/api/users/${user.id}`, {
        method: 'PUT',
        credentials: 'include'
      });

      const data = await res.json();
      if (!res.ok) throw new Error(data.message || 'Failed to toggle status');

      // Update local state with the actual value returned from the server
      setUsers(prev => prev.map(u => u.id === user.id ? { ...u, active: data.user.active } : u));
      setMessage(data.message);
    } catch (err: any) {
      setError(err.message || 'An error occurred during status update');
    }
  };

  // --- Fetch Users ---
  const fetchUsers = useCallback(async () => {
    try {
      setLoading(true);
      setError('');
      const res = await fetch('/api/users', { 
        method: 'GET',
        credentials: 'include' 
      });

      if (res.status === 401) {
        router.push('/');
        return;
      }

      const data = await res.json();
      if (!res.ok) throw new Error(data.message || 'Unable to load users');
      setUsers((data as RawUser[]).map(normalizeUser));
    } catch (err: any) {
      setError(err.message || 'Something went wrong');
    } finally {
      setLoading(false);
    }
  }, [router]);

  useEffect(() => {
    if (!username) {
      router.push('/');
      return;
    }
    fetchUsers();
  }, [fetchUsers, router, username]);

  // --- Search Logic ---
  const filteredUsers = useMemo(() => {
    const term = searchTerm.trim().toLowerCase();
    if (!term) return users;
    return users.filter((u) => 
      u.name.toLowerCase().includes(term) || 
      (u.fullname && u.fullname.toLowerCase().includes(term))
    );
  }, [users, searchTerm]);

  return (
    <div className="space-y-4">
      
      {/* --- HEADER --- */}
      <div className="flex items-center justify-between gap-x-6 bg-white p-4 rounded-lg shadow-sm border border-gray-100">
        <h1 className="text-xl font-bold text-gray-900 whitespace-nowrap">
          User Management
        </h1>
        
        <div className="relative flex-1 max-w-md">
          <input
            type="text"
            value={searchTerm}
            onChange={(e) => setSearchTerm(e.target.value)}
            placeholder="Search users..."
            className="w-full rounded-md border border-gray-300 px-4 py-2 text-sm focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none"
          />
          {searchTerm && (
            <button
              onClick={() => setSearchTerm('')}
              className="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600 font-bold"
            >
              ✕
            </button>
          )}
        </div>

        <button
          className="rounded-md bg-blue-600 px-5 py-2 text-sm font-semibold text-white hover:bg-blue-700 transition-colors shadow-sm whitespace-nowrap"
        >
          + Add User
        </button>
      </div>

      {error && (
        <div className="bg-red-50 border border-red-200 text-red-700 px-4 py-2 rounded text-sm">
          {error}
        </div>
      )}

      {/* --- TABLE SECTION --- */}
      <div className="bg-white rounded-lg shadow border border-gray-200 overflow-hidden">
        {loading ? (
          <div className="p-12 text-center text-gray-500 font-medium italic">Loading users...</div>
        ) : filteredUsers.length === 0 ? (
          <div className="p-12 text-center text-gray-500">No users found.</div>
        ) : (
          <div className="max-h-[calc(100vh-260px)] overflow-auto bg-white">
            <table className="min-w-full divide-y divide-gray-200">
            
              <thead className="bg-gray-200">
                <tr>
                  <th className="sticky left-0 z-20 bg-gray-100 px-4 py-3 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">
                    Row #
                  </th>
                  <th className="sticky left-[48px] z-20 bg-gray-100 px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                    Name
                  </th>
                  <th className="sticky left-[160px] z-20 bg-gray-100 px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider shadow-[2px_0_5px_-2px_rgba(0,0,0,0.1)]">
                    Active
                  </th>
                  <th className="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Full Name</th>
                  <th className="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Birthdate</th>
                  <th className="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Gender</th>
                  <th className="px-6 py-3 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">Actions</th>
                </tr>
              </thead>
              <tbody className="bg-white divide-y divide-gray-200">
                {filteredUsers.map((user, index) => (
                  <tr 
                    key={user.id} 
                    className="even:bg-gray-50/80 hover:bg-blue-50/40 transition-colors group"
                  >
                    <td className="sticky left-0 z-10 bg-inherit px-4 py-4 text-sm text-gray-500 text-right" >
                      {index + 1}
                    </td>
                    <td className="sticky left-[48px] z-10 bg-inherit px-6 py-4 text-sm font-medium text-gray-900">
                      {user.name}
                    </td>
                    <td className="sticky left-[160px] z-10 bg-inherit px-6 py-4 shadow-[2px_0_5px_-2px_rgba(0,0,0,0.1)]">
                      <input
                        type="checkbox"
                        readOnly
                        checked={user.active}
                        className="h-4 w-4 rounded border-gray-300 text-blue-500 opacity-70 cursor-not-allowed"
                      />
                    </td>
                    <td className="px-6 py-4 text-sm text-gray-600 whitespace-nowrap">{user.fullname || '—'}</td>
                    <td className="px-6 py-4 text-sm text-gray-600 whitespace-nowrap">
                      {user.birthdate ? user.birthdate.toLocaleDateString() : '—'}
                    </td>
                    <td className="px-6 py-4 text-sm text-gray-600 uppercase">{user.gender || '—'}</td>
                    <td className="px-6 py-4 text-center whitespace-nowrap space-x-3">
                      <button 
                        className="text-blue-600 hover:text-blue-900 font-semibold text-sm"
                      >
                        Edit
                      </button>
                      <button
                        onClick={() => handleToggleStatus(user)}
                        className={`min-w-[100px] px-3 py-1 rounded text-xs font-bold text-white shadow-sm transition-colors ${
                          user.active 
                            ? 'bg-red-600 hover:bg-red-700' 
                            : 'bg-green-600 hover:bg-green-700'
                        }`}
                      >
                        {user.active ? 'Deactivate' : 'Activate'}
                      </button>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        )}
      </div>

      {!loading && (
        <div className="text-sm text-gray-600">
          Showing {filteredUsers.length} of {users.length} total users
        </div>
      )}

      {message && <MessageModal message={message} onClose={() => setMessage('')} />}
    </div>
  );
}